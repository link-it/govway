<project name="openspcoop2-swagger-codegen">
    <description>
        Produzione dei sorgenti a partire da una definizione swagger
    </description>
	
	<!-- estensione di ant (if .... ) -->
	<taskdef resource="net/sf/antcontrib/antlib.xml">
          <classpath>
              <pathelement location="${required_lib}/ant/ant-contrib-1.0b3.jar"/>
          </classpath>
	</taskdef>
	
		
	<!-- generazione sorgenti-->
	<target name="-swagger_codegen">
				
		<!-- Credo directory temporanea che contiene l'output del progetto maven generato -->
		<delete dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN"/>
		<mkdir dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN"/>

		<!-- per vedere i parametri disponibili: java -jar swagger-codegen-cli-3.0.0.jar config-help -l jaxrs-cxf -->
		<property name="configSwaggerTemplate" location="${openspcoop2}/ant/commons/swagger-codegen-config.json"/>
		<property name="configSwagger" value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/swagger-codegen-config.json"/>
		<copy file="${configSwaggerTemplate}" tofile="${configSwagger}"/>
		<replace file="${configSwagger}" token="WITHXMLOPTION" value="${swaggerCodeGen.withXmlAnnotations}"/>
		<replace file="${configSwagger}" token="BEANVALIDATION" value="${swaggerCodeGen.beanValidation}"/>

		<!-- template custom -->
		<var name="propTemplateKey" value=""/>
		<var name="propTemplateValue" value=""/>
		<if>
			<istrue value="${swaggerCodeGen.useGovwayTemplate}" />
			<then>
				<unzip src="${required_lib}/swagger-codegen/swagger-codegen-cli-3.0.0-templates.gw.jar" dest="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/template"/>
				<java jar="${required_lib}/swagger-codegen/swagger-codegen-cli-3.0.0.jar" fork="true">
					<arg value="generate" />
					<arg value="--input-spec" />
					<arg value="${swaggerCodeGen.inputSpec}" />
					<arg value="--lang" />
					<arg value="jaxrs-cxf" />
					<arg value="--api-package" />
					<arg value="${swaggerCodeGen.package}.api" />
					<arg value="--model-package" />
					<arg value="${swaggerCodeGen.package}.model" />
					<!--
					Non funziona (aggiungere un - se si scommenta)
					<arg value="-invoker-package" />
					<arg value="${swaggerCodeGen.package}.impl" />
					-->
					<arg value="--output" />
					<arg value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN" />
					<arg value="--config" />
					<arg value="${configSwagger}" />
					<arg value="--template-dir" />
					<arg value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/template/v2/JavaJaxRS/cxf" />
					<classpath>
		<!--
						<pathelement path="${required_lib}/swagger/*.jar"/>
		-->
					</classpath>
				</java>
			</then>
			<else>
				<java jar="${required_lib}/swagger-codegen/swagger-codegen-cli-3.0.0.jar" fork="true">
					<arg value="generate" />
					<arg value="--input-spec" />
					<arg value="${swaggerCodeGen.inputSpec}" />
					<arg value="--lang" />
					<arg value="jaxrs-cxf" />
					<arg value="--api-package" />
					<arg value="${swaggerCodeGen.package}.api" />
					<arg value="--model-package" />
					<arg value="${swaggerCodeGen.package}.model" />
					<!--
					Non funziona (aggiungere un - se si scommenta)
					<arg value="-invoker-package" />
					<arg value="${swaggerCodeGen.package}.impl" />
					-->
					<arg value="--output" />
					<arg value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN" />
					<arg value="--config" />
					<arg value="${configSwagger}" />
					<classpath>
		<!--
						<pathelement path="${required_lib}/swagger/*.jar"/>
		-->
					</classpath>
				</java>
			</else>
		</if>
			
		<delete failonerror="false">
			<fileset dir="${src_govwayMonitorApiRS}/${swaggerCodeGen.packagePath}/api">
				<include name="*.java"/>
			</fileset>
		</delete>
		<delete failonerror="false">
			<fileset dir="${src_govwayMonitorApiRS}/${swaggerCodeGen.packagePath}/model">
				<include name="*.java"/>
			</fileset>
		</delete>
		<if>
			<istrue value="${swaggerCodeGen.writeImpl}" />
			<then>
				<delete failonerror="false">
					<fileset dir="${src_govwayMonitorApiRS}/${swaggerCodeGen.packagePath}/api/impl">
						<include name="*.java"/>
					</fileset>
				</delete>
			</then>
		</if>

		<copy todir="${swaggerCodeGen.outputDir}">
			<fileset dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/src/gen/java">
				<include name="**/*.java"/>
			</fileset>
		</copy>
		<if>
			<istrue value="${swaggerCodeGen.writeImpl}" />
			<then>
				<copy todir="${swaggerCodeGen.outputDir}">
					<fileset dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/src/main/java">
						<include name="**/*.java"/>
					</fileset>
				</copy>
			</then>
		</if>

		<delete dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN"/>

	</target>

	<target name="-swagger_codegen_components">
		
		<!-- Credo directory temporanea che contiene l'output del progetto maven generato -->
		<delete dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN"/>
		<mkdir dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN"/>

		<!-- per vedere i parametri disponibili: java -jar swagger-codegen-cli-3.0.0.jar config-help -l jaxrs-cxf -->
		<property name="configSwaggerTemplate" location="${openspcoop2}/ant/commons/swagger-codegen-config.json"/>
		<property name="configSwagger" value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/swagger-codegen-config.json"/>
		<copy file="${configSwaggerTemplate}" tofile="${configSwagger}"/>
		<replace file="${configSwagger}" token="WITHXMLOPTION" value="${swaggerCodeGen.withXmlAnnotations}"/>
		<replace file="${configSwagger}" token="BEANVALIDATION" value="${swaggerCodeGen.beanValidation}"/>

		<!-- Interfaccia Swagger -->
		<property name="swagger" value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/swagger.yaml"/>
		<concat destfile="${swagger}" append="yes">
openapi: 3.0.0
servers: []
info:
  description: Prefisso per la generazione di model
  version: 1.0.0
  title: GovWay API
  contact:
    email: info@link.it
paths:
  '/path':
    get:
      parameters:
        - in: path
          name: id
          description: identificativo
          required: true
          schema:
            type: string
      responses:
        '200':
</concat>
		<concat destfile="${swagger}" append="yes">
			<path>
			    <pathelement location="${swaggerCodeGen.inputSpec}"/>
			</path>
		</concat>

		<!-- Generazione -->
		<java jar="${required_lib}/swagger-codegen/swagger-codegen-cli-3.0.0.jar" fork="true">
			<arg value="generate" />
			<arg value="--input-spec" />
			<arg value="${swagger}" />
			<arg value="--lang" />
			<arg value="jaxrs-cxf" />
			<arg value="--api-package" />
			<arg value="${swaggerCodeGen.package}.TMPapiTMP" />
			<arg value="--model-package" />
			<arg value="${swaggerCodeGen.package}" />
			<!--
			Non funziona (aggiungere un - se si scommenta)
			<arg value="-invoker-package" />
			<arg value="${swaggerCodeGen.package}.impl" />
			-->
			<arg value="--output" />
			<arg value="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN" />
			<arg value="--config" />
			<arg value="${configSwagger}" />
			<classpath>
<!--
				<pathelement path="${required_lib}/swagger/*.jar"/>
-->
			</classpath>
		</java>

		<delete failonerror="false">
			<fileset dir="${src_govwayMonitorApiRS}/${swaggerCodeGen.packagePath}">
				<include name="*.java"/>
			</fileset>
		</delete>
		<copy todir="${swaggerCodeGen.outputDir}">
			<fileset dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN/src/gen/java">
				<exclude name="**/TMPapiTMP/**"/>
				<exclude name="**/TMPapiTMP"/>
			</fileset>
		</copy>

		<delete dir="${swaggerCodeGen.outputDir}/TMP_DIR_SWAGGER_CODEGEN"/>

	</target>
	
	
</project>
